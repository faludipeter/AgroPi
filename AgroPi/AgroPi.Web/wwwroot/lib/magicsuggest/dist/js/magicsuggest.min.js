(function(n){"use strict";var t=function(t,i){var u=this,p={allowFreeEntries:!0,allowDuplicates:!1,ajaxConfig:{},autoSelect:!0,selectFirst:!1,queryParam:"query",beforeSend:function(){},cls:"",data:null,dataUrlParams:{},disabled:!1,disabledField:null,displayField:"name",editable:!0,expanded:!1,expandOnFocus:!1,groupBy:null,hideTrigger:!1,highlight:!0,id:null,infoMsgCls:"",inputCfg:{},invalidCls:"ms-inv",matchCase:!1,maxDropHeight:290,maxEntryLength:null,maxEntryRenderer:function(n){return"Please reduce your entry by "+n+" character"+(n>1?"s":"")},maxSuggestions:null,maxSelection:10,maxSelectionRenderer:function(n){return"You cannot choose more than "+n+" item"+(n>1?"s":"")},method:"POST",minChars:0,minCharsRenderer:function(n){return"Please type "+n+" more character"+(n>1?"s":"")},mode:"local",name:null,noSuggestionText:"No suggestions",placeholder:"Type or click here",renderer:null,required:!1,resultAsString:!1,resultAsStringDelimiter:",",resultsField:"results",selectionCls:"",selectionContainer:null,selectionPosition:"inner",selectionRenderer:null,selectionStacked:!1,sortDir:"asc",sortOrder:null,strictSuggest:!1,style:"",toggleOnClick:!1,typeDelay:400,useTabKey:!1,useCommaKey:!0,useZebraStyle:!1,value:null,valueField:"id",vregex:null,vtype:null},w=n.extend({},i),r=n.extend(!0,{},p,w);this.addToSelection=function(t,i){if(!r.maxSelection||e.length<r.maxSelection){n.isArray(t)||(t=[t]);var o=!1;n.each(t,function(t,i){(r.allowDuplicates||n.inArray(i[r.valueField],u.getValue())===-1)&&(e.push(i),o=!0)});o===!0&&(f._renderSelection(),this.empty(),i!==!0&&n(this).trigger("selectionchange",[this,this.getSelection()]))}this.input.attr("placeholder",r.selectionPosition==="inner"&&this.getValue().length>0?"":r.placeholder)};this.clear=function(n){this.removeFromSelection(e.slice(0),n)};this.collapse=function(){r.expanded===!0&&(this.combobox.detach(),r.expanded=!1,n(this).trigger("collapse",[this]))};this.disable=function(){this.container.addClass("ms-ctn-disabled");r.disabled=!0;u.input.attr("disabled",!0)};this.empty=function(){this.input.val("")};this.enable=function(){this.container.removeClass("ms-ctn-disabled");r.disabled=!1;u.input.attr("disabled",!1)};this.expand=function(){!r.expanded&&(this.input.val().length>=r.minChars||this.combobox.children().length>0)&&(this.combobox.appendTo(this.container),f._processSuggestions(),r.expanded=!0,n(this).trigger("expand",[this]))};this.isDisabled=function(){return r.disabled};this.isValid=function(){var t=r.required===!1||e.length>0;return(r.vtype||r.vregex)&&n.each(e,function(n,i){t=t&&f._validateSingleItem(i[r.valueField])}),t};this.getDataUrlParams=function(){return r.dataUrlParams};this.getName=function(){return r.name};this.getSelection=function(){return e};this.getRawValue=function(){return u.input.val()};this.getValue=function(){return n.map(e,function(n){return n[r.valueField]})};this.removeFromSelection=function(t,i){n.isArray(t)||(t=[t]);var o=!1;n.each(t,function(t,i){var f=n.inArray(i[r.valueField],u.getValue());f>-1&&(e.splice(f,1),o=!0)});o===!0&&(f._renderSelection(),i!==!0&&n(this).trigger("selectionchange",[this,this.getSelection()]),r.expandOnFocus&&u.expand(),r.expanded&&f._processSuggestions());this.input.attr("placeholder",r.selectionPosition==="inner"&&this.getValue().length>0?"":r.placeholder)};this.getData=function(){return a};this.setData=function(n){r.data=n;f._processSuggestions()};this.setName=function(t){r.name=t;t&&(r.name+=t.indexOf("[]")>0?"":"[]");u._valueContainer&&n.each(u._valueContainer.children(),function(n,t){t.name=r.name})};this.setSelection=function(n){this.clear();this.addToSelection(n)};this.setValue=function(t){var i=[];n.each(t,function(t,u){var e=!1,f;n.each(a,function(n,t){if(t[r.valueField]==u)return i.push(t),e=!0,!1});e||(typeof u=="object"?i.push(u):(f={},f[r.valueField]=u,f[r.displayField]=u,i.push(f)))});i.length>0&&this.addToSelection(i)};this.setDataUrlParams=function(t){r.dataUrlParams=n.extend({},t)};var e=[],h=0,y,c=!1,l=null,a=[],v=!1,o={BACKSPACE:8,TAB:9,ENTER:13,CTRL:17,ESC:27,SPACE:32,UPARROW:38,DOWNARROW:40,COMMA:188},f={_displaySuggestions:function(t){var i,e,o,s,c,a;if(u.combobox.show(),u.combobox.empty(),i=0,e=0,l===null)f._renderComboItems(t),i=h*t.length;else{for(o in l)e+=1,n("<div/>",{"class":"ms-res-group",html:o}).appendTo(u.combobox),f._renderComboItems(l[o].items,!0);s=u.combobox.find(".ms-res-group").outerHeight();s!==null?(c=e*s,i=h*t.length+c):i=h*(t.length+e)}i<u.combobox.height()||i<=r.maxDropHeight?u.combobox.height(i):i>=u.combobox.height()&&i>r.maxDropHeight&&u.combobox.height(r.maxDropHeight);t.length===1&&r.autoSelect===!0&&u.combobox.children().filter(":not(.ms-res-item-disabled):last").addClass("ms-res-item-active");r.selectFirst===!0&&u.combobox.children().filter(":not(.ms-res-item-disabled):first").addClass("ms-res-item-active");t.length===0&&u.getRawValue()!==""&&(a=r.noSuggestionText.replace(/\{\{.*\}\}/,u.input.val()),f._updateHelper(a),u.collapse());r.allowFreeEntries===!1&&(t.length===0?(n(u.input).addClass(r.invalidCls),u.combobox.hide()):n(u.input).removeClass(r.invalidCls))},_getEntriesFromStringArray:function(t){var i=[];return n.each(t,function(t,u){var f={};f[r.displayField]=f[r.valueField]=n.trim(u);i.push(f)}),i},_highlightSuggestion:function(t){var i=u.input.val(),f;return(n.each(["^","$","*","+","?",".","(",")",":","!","|","{","}","[","]"],function(n,t){i=i.replace(t,"\\"+t)}),i.length===0)?t:(f=r.matchCase===!0?"g":"gi",t.replace(new RegExp("("+i+")(?!([^<]+)?>)",f),"<em>$1<\/em>"))},_moveSelectedRow:function(n){r.expanded||u.expand();var i,t,f,e;i=u.combobox.find(".ms-res-item:not(.ms-res-item-disabled)");t=n==="down"?i.eq(0):i.filter(":last");f=u.combobox.find(".ms-res-item-active:not(.ms-res-item-disabled):first");f.length>0&&(n==="down"?(t=f.nextAll(".ms-res-item:not(.ms-res-item-disabled)").first(),t.length===0&&(t=i.eq(0)),e=u.combobox.scrollTop(),u.combobox.scrollTop(0),t[0].offsetTop+t.outerHeight()>u.combobox.height()&&u.combobox.scrollTop(e+h)):(t=f.prevAll(".ms-res-item:not(.ms-res-item-disabled)").first(),t.length===0&&(t=i.filter(":last"),u.combobox.scrollTop(h*i.length)),t[0].offsetTop<u.combobox.scrollTop()&&u.combobox.scrollTop(u.combobox.scrollTop()-h)));i.removeClass("ms-res-item-active");t.addClass("ms-res-item-active")},_processSuggestions:function(t){var e=null,i=t||r.data,o,s,h;if(i!==null){if(typeof i=="function"&&(i=i.call(u,u.getRawValue())),typeof i=="string"){n(u).trigger("beforeload",[u]);o={};o[r.queryParam]=u.input.val();s=n.extend(o,r.dataUrlParams);n.ajax(n.extend({type:r.method,url:i,data:s,beforeSend:r.beforeSend,success:function(t){e=typeof t=="string"?JSON.parse(t):t;f._processSuggestions(e);n(u).trigger("load",[u,e]);f._asyncValues&&(u.setValue(typeof f._asyncValues=="string"?JSON.parse(f._asyncValues):f._asyncValues),f._renderSelection(),delete f._asyncValues)},error:function(){throw"Could not reach server";}},r.ajaxConfig));return}a=i.length>0&&typeof i[0]=="string"?f._getEntriesFromStringArray(i):i[r.resultsField]||i;h=r.mode==="remote"?a:f._sortAndTrim(a);f._displaySuggestions(f._group(h))}},_render:function(t){u.setName(r.name);u.container=n("<div/>",{"class":"ms-ctn form-control "+(r.resultAsString?"ms-as-string ":"")+r.cls+(n(t).hasClass("input-lg")?" input-lg":"")+(n(t).hasClass("input-sm")?" input-sm":"")+(r.disabled===!0?" ms-ctn-disabled":"")+(r.editable===!0?"":" ms-ctn-readonly")+(r.hideTrigger===!1?"":" ms-no-trigger"),style:r.style,id:r.id});u.container.on("focus",n.proxy(s._onFocus,this));u.container.on("blur",n.proxy(s._onBlur,this));u.container.on("keydown",n.proxy(s._onKeyDown,this));u.container.on("keyup",n.proxy(s._onKeyUp,this));u.input=n("<input/>",n.extend({type:"text","class":r.editable===!0?"":" ms-input-readonly",readonly:!r.editable,placeholder:r.placeholder,disabled:r.disabled},r.inputCfg));u.input.on("focus",n.proxy(s._onInputFocus,this));u.input.on("click",n.proxy(s._onInputClick,this));u.combobox=n("<div/>",{"class":"ms-res-ctn dropdown-menu"}).height(r.maxDropHeight);u.combobox.on("click","div.ms-res-item",n.proxy(s._onComboItemSelected,this));u.combobox.on("mouseover","div.ms-res-item",n.proxy(s._onComboItemMouseOver,this));r.selectionContainer?(u.selectionContainer=r.selectionContainer,n(u.selectionContainer).addClass("ms-sel-ctn")):u.selectionContainer=n("<div/>",{"class":"ms-sel-ctn"});u.selectionContainer.on("click",n.proxy(s._onFocus,this));if(r.selectionPosition!=="inner"||r.selectionContainer?u.container.append(u.input):u.selectionContainer.append(u.input),u.helper=n("<span/>",{"class":"ms-helper "+r.infoMsgCls}),f._updateHelper(),u.container.append(u.helper),n(t).replaceWith(u.container),!r.selectionContainer)switch(r.selectionPosition){case"bottom":u.selectionContainer.insertAfter(u.container);r.selectionStacked===!0&&(u.selectionContainer.width(u.container.width()),u.selectionContainer.addClass("ms-stacked"));break;case"right":u.selectionContainer.insertAfter(u.container);u.container.css("float","left");break;default:u.container.append(u.selectionContainer)}if(r.hideTrigger===!1){u.trigger=n("<div/>",{"class":"ms-trigger",html:'<div class="ms-trigger-ico"><\/div>'});u.trigger.on("click",n.proxy(s._onTriggerClick,this));u.container.append(u.trigger)}n(window).on("resize",n.proxy(s._onWindowResized,this));(r.value!==null||r.data!==null)&&(typeof r.data=="string"?(f._asyncValues=r.value,f._processSuggestions()):(f._processSuggestions(),r.value!==null&&(u.setValue(r.value),f._renderSelection())));n("body").on("click",function(n){u.container.hasClass("ms-ctn-focus")&&u.container.has(n.target).length===0&&n.target.className.indexOf("ms-res-item")<0&&n.target.className.indexOf("ms-close-btn")<0&&u.container[0]!==n.target&&s._onBlur()});r.expanded===!0&&(r.expanded=!1,u.expand())},_renderComboItems:function(t,i){var o=this,e="";n.each(t,function(t,u){var s=r.renderer!==null?r.renderer.call(o,u):u[r.displayField],h=r.disabledField!==null&&u[r.disabledField]===!0,c=n("<div/>",{"class":"ms-res-item "+(i?"ms-res-item-grouped ":"")+(h?"ms-res-item-disabled ":"")+(t%2==1&&r.useZebraStyle===!0?"ms-res-odd":""),html:r.highlight===!0?f._highlightSuggestion(s):s,"data-json":JSON.stringify(u)});e+=n("<div/>").append(c).html()});u.combobox.append(e);h=u.combobox.find(".ms-res-item:first").outerHeight()},_renderSelection:function(){var t=this,i=0,o=0,h=[],l=r.resultAsString===!0&&!c;u.selectionContainer.find(".ms-sel-item").remove();u._valueContainer!==undefined&&u._valueContainer.remove();n.each(e,function(i,u){var o,c,a=r.selectionRenderer!==null?r.selectionRenderer.call(t,u):u[r.displayField],v=f._validateSingleItem(u[r.displayField])?"":" ms-sel-invalid";if(l===!0)o=n("<div/>",{"class":"ms-sel-item ms-sel-text "+r.selectionCls+v,html:a+(i===e.length-1?"":r.resultAsStringDelimiter)}).data("json",u);else if(o=n("<div/>",{"class":"ms-sel-item "+r.selectionCls+v,html:a}).data("json",u),r.disabled===!1){c=n("<span/>",{"class":"ms-close-btn"}).data("json",u).appendTo(o);c.on("click",n.proxy(s._onTagTriggerClick,t))}h.push(o)});u.selectionContainer.prepend(h);u._valueContainer=n("<div/>",{style:"display: none;"});n.each(u.getValue(),function(t,i){var f=n("<input/>",{type:"hidden",name:r.name,value:i});f.appendTo(u._valueContainer)});u._valueContainer.appendTo(u.selectionContainer);r.selectionPosition!=="inner"||r.selectionContainer||(u.input.width(0),o=u.input.offset().left-u.selectionContainer.offset().left,i=u.container.width()-o-42,u.input.width(i));e.length===r.maxSelection?f._updateHelper(r.maxSelectionRenderer.call(this,e.length)):u.helper.hide()},_selectItem:function(n){r.maxSelection===1&&(e=[]);u.addToSelection(n.data("json"));n.removeClass("ms-res-item-active");(r.expandOnFocus===!1||e.length===r.maxSelection)&&u.collapse();c?c&&(r.expandOnFocus||v)&&(f._processSuggestions(),v&&u.expand()):u.input.trigger("focus")},_sortAndTrim:function(t){var f=u.getRawValue(),e=[],i=[],o=u.getValue();return f.length>0?n.each(t,function(n,t){var i=t[r.displayField];(r.matchCase===!0&&i.indexOf(f)>-1||r.matchCase===!1&&i.toLowerCase().indexOf(f.toLowerCase())>-1)&&(r.strictSuggest===!1||i.toLowerCase().indexOf(f.toLowerCase())===0)&&e.push(t)}):e=t,n.each(e,function(t,u){(r.allowDuplicates||n.inArray(u[r.valueField],o)===-1)&&i.push(u)}),r.sortOrder!==null&&i.sort(function(n,t){return n[r.sortOrder]<t[r.sortOrder]?r.sortDir==="asc"?-1:1:n[r.sortOrder]>t[r.sortOrder]?r.sortDir==="asc"?1:-1:0}),r.maxSuggestions&&r.maxSuggestions>0&&(i=i.slice(0,r.maxSuggestions)),i},_group:function(t){return r.groupBy!==null&&(l={},n.each(t,function(n,t){var u=r.groupBy.indexOf(".")>-1?r.groupBy.split("."):r.groupBy,i=t[r.groupBy];if(typeof u!="string")for(i=t;u.length>0;)i=i[u.shift()];l[i]===undefined?l[i]={title:i,items:[t]}:l[i].items.push(t)})),t},_updateHelper:function(n){u.helper.html(n);u.helper.is(":visible")||u.helper.fadeIn()},_validateSingleItem:function(n){if(r.vregex!==null&&r.vregex instanceof RegExp)return r.vregex.test(n);if(r.vtype!==null)switch(r.vtype){case"alpha":return/^[a-zA-Z_]+$/.test(n);case"alphanum":return/^[a-zA-Z0-9_]+$/.test(n);case"email":return/^(\w+)([\-+.][\w]+)*@(\w[\-\w]*\.){1,5}([A-Za-z]){2,6}$/.test(n);case"url":return/(((^https?)|(^ftp)):\/\/([\-\w]+\.)+\w{2,3}(\/[%\-\w]+(\.\w{2,})?)*(([\w\-\.\?\\\/+@&#;`~=%!]*)(\.\w{2,})?)*\/?)/i.test(n);case"ipaddress":return/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(n)}return!0}},s={_onBlur:function(){if(u.container.removeClass("ms-ctn-focus"),u.collapse(),c=!1,u.getRawValue()!==""&&r.allowFreeEntries===!0){var t={};t[r.displayField]=t[r.valueField]=n.trim(u.getRawValue());u.addToSelection(t)}f._renderSelection();u.isValid()===!1?u.container.addClass(r.invalidCls):u.input.val()!==""&&r.allowFreeEntries===!1&&(u.empty(),f._updateHelper(""));n(u).trigger("blur",[u])},_onComboItemMouseOver:function(t){var i=n(t.currentTarget);i.hasClass("ms-res-item-disabled")||(u.combobox.children().removeClass("ms-res-item-active"),i.addClass("ms-res-item-active"))},_onComboItemSelected:function(t){var i=n(t.currentTarget);i.hasClass("ms-res-item-disabled")||f._selectItem(n(t.currentTarget))},_onFocus:function(){u.input.trigger("focus")},_onInputClick:function(){u.isDisabled()===!1&&c&&r.toggleOnClick===!0&&(r.expanded?u.collapse():u.expand())},_onInputFocus:function(){if(u.isDisabled()===!1&&!c){c=!0;u.container.addClass("ms-ctn-focus");u.container.removeClass(r.invalidCls);var t=u.getRawValue().length;r.expandOnFocus===!0&&u.expand();e.length===r.maxSelection?f._updateHelper(r.maxSelectionRenderer.call(this,e.length)):t<r.minChars&&f._updateHelper(r.minCharsRenderer.call(this,r.minChars-t));f._renderSelection();n(u).trigger("focus",[u])}},_onKeyDown:function(t){var h=u.combobox.find(".ms-res-item-active:not(.ms-res-item-disabled):first"),i=u.input.val();if(n(u).trigger("keydown",[u,t]),t.keyCode===o.TAB&&(r.useTabKey===!1||r.useTabKey===!0&&h.length===0&&u.input.val().length===0)){s._onBlur();return}switch(t.keyCode){case o.BACKSPACE:i.length===0&&u.getSelection().length>0&&r.selectionPosition==="inner"&&(e.pop(),f._renderSelection(),n(u).trigger("selectionchange",[u,u.getSelection()]),u.input.attr("placeholder",r.selectionPosition==="inner"&&u.getValue().length>0?"":r.placeholder),u.input.trigger("focus"),t.preventDefault());break;case o.TAB:case o.ESC:t.preventDefault();break;case o.ENTER:(i!==""||r.expanded)&&t.preventDefault();break;case o.COMMA:r.useCommaKey===!0&&t.preventDefault();break;case o.CTRL:v=!0;break;case o.DOWNARROW:t.preventDefault();f._moveSelectedRow("down");break;case o.UPARROW:t.preventDefault();f._moveSelectedRow("up");break;default:e.length===r.maxSelection&&t.preventDefault()}},_onKeyUp:function(t){var i=u.getRawValue(),c=n.trim(u.input.val()).length>0&&(!r.maxEntryLength||n.trim(u.input.val()).length<=r.maxEntryLength),s,h={};if(n(u).trigger("keyup",[u,t]),clearTimeout(y),t.keyCode===o.ESC&&r.expanded&&u.combobox.hide(),t.keyCode===o.TAB&&r.useTabKey===!1||t.keyCode>o.ENTER&&t.keyCode<o.SPACE){t.keyCode===o.CTRL&&(v=!1);return}switch(t.keyCode){case o.UPARROW:case o.DOWNARROW:t.preventDefault();break;case o.ENTER:case o.TAB:case o.COMMA:if(t.keyCode!==o.COMMA||r.useCommaKey===!0){if(t.preventDefault(),r.expanded===!0&&(s=u.combobox.find(".ms-res-item-active:not(.ms-res-item-disabled):first"),s.length>0)){f._selectItem(s);return}c===!0&&r.allowFreeEntries===!0&&(h[r.displayField]=h[r.valueField]=n.trim(i),u.addToSelection(h),u.collapse(),u.input.trigger("focus"));break}default:e.length===r.maxSelection?f._updateHelper(r.maxSelectionRenderer.call(this,e.length)):i.length<r.minChars?(f._updateHelper(r.minCharsRenderer.call(this,r.minChars-i.length)),r.expanded===!0&&u.collapse()):r.maxEntryLength&&i.length>r.maxEntryLength?(f._updateHelper(r.maxEntryRenderer.call(this,i.length-r.maxEntryLength)),r.expanded===!0&&u.collapse()):(u.helper.hide(),r.minChars<=i.length&&(y=setTimeout(function(){r.expanded===!0?f._processSuggestions():u.expand()},r.typeDelay)))}},_onTagTriggerClick:function(t){u.removeFromSelection(n(t.currentTarget).data("json"))},_onTriggerClick:function(){if(u.isDisabled()===!1&&!(r.expandOnFocus===!0&&e.length===r.maxSelection))if(n(u).trigger("triggerclick",[u]),r.expanded===!0)u.collapse();else{var t=u.getRawValue().length;t>=r.minChars?(u.input.trigger("focus"),u.expand()):f._updateHelper(r.minCharsRenderer.call(this,r.minChars-t))}},_onWindowResized:function(){f._renderSelection()}};t!==null&&f._render(t)};n.fn.magicSuggest=function(i){var r=n(this);return r.length===1&&r.data("magicSuggest")?r.data("magicSuggest"):(r.each(function(){var f=n(this),u,r;f.data("magicSuggest")||(this.nodeName.toLowerCase()==="select"&&(i.data=[],i.value=[],n.each(this.children,function(t,r){r.nodeName&&r.nodeName.toLowerCase()==="option"&&(i.data.push({id:r.value,name:r.text}),n(r).attr("selected")&&i.value.push(r.value))})),u={},n.each(this.attributes,function(n,t){u[t.name]=t.name==="value"&&t.value!==""?JSON.parse(t.value):t.value}),r=new t(this,n.extend([],n.fn.magicSuggest.defaults,i,u)),f.data("magicSuggest",r),r.container.data("magicSuggest",r))}),r.length===1)?r.data("magicSuggest"):r};n.fn.magicSuggest.defaults={}})(jQuery);